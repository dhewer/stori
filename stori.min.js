/**
 * stori - v0.8.0 - Darren Hewer 2017
 * darrenhewer.com/stori | github.com/dhewer/stori
 */
!function(a){"use strict";var b="stori";a.Stori=function(b,c){var d=this;return d.defaults={buttonBack:!0,buttonBackHtml:'<button class="stori-button stori-back" title="Back"></button>',buttonForward:!0,buttonForwardHtml:'<button class="stori-button stori-forward" title="Forward"></button>',buttonRestart:!0,buttonRestartHtml:'<button class="stori-button stori-restart" title="Restart"></button>',controls:"top",controlsHtml:!1,debug:!0,focus:!0,history:"clear",linear:!1,linearDropDown:!0,start:!1,transition:"fade",transitionSpeed:250,warn:!1},d.opts={},d.id=b.attr("id"),d.id?(d.historyName="stori_"+d.id,d.pointer=0,d.pointerName="stori_"+d.id+"_pointer",d.linearName="stori-"+d.id+"-p-",d.initialLoad=!0,a("body").addClass("stori-js"),d.init=function(c){d.opts=a.extend({},d.defaults,c),b.addClass("stori").children(":not(.stori-ignore)").addClass("stori-page").hide(),d.fixOpts(),d.history=d.historyGet(),d.opts.linear&&d.setupLinear(),d.setupOpts(),d.setupControls(),d.pageGo(d.current,d.opts.transition,!1)},d.fixOpts=function(){!d.opts.history||"LOCAL"!==d.opts.history.toUpperCase()&&"LOCALSTORAGE"!==d.opts.history.toUpperCase()||(d.opts.history="keep"),d.opts.history&&"SESSIONSTORAGE"===d.opts.history.toUpperCase()&&(d.opts.history="session"),d.opts.transition&&"NONE"===d.opts.transition.toUpperCase()&&(d.opts.transition=!1),!1===d.opts.controls&&(d.opts.controls="none")},d.setupOpts=function(){d.opts.start=a(d.opts.start?d.opts.start:a(b.children())[0]),d.opts.start&&d.opts.start.length||d.opts.debug&&console.warn("stori: Start element does not exist"),d.history&&d.history.length||d.historyAdd(d.opts.start),d.current=d.history[d.pointer]},d.setupLinear=function(){var e,c=0,f='<select class="stori-pageList">';if(d.history=[],d.historyEmpty(),b.addClass("stori-linear"),b.children(":not(.stori-ignore)").each(function(){e=d.linearName+c,a(this).attr("id",e),d.historyAdd("#"+e),0===++c&&(d.opts.start=a("#"+e))}),d.opts.linearDropDown){for(var g=0;g<d.history.length;g++){var h="";h=a(d.history[g]).attr("title"),f+='<option value="'+g+'">',f+="Page "+(g+1),h&&(f+=": "+h),f+="</option>"}f+="</select>",d.selectHtml=f}},d.setupControls=function(){var a=d.opts.controls;"none"!==a&&("bottom"!==a&&"both"!==a||b.append('<div class="stori-controls stori-controls-default stori-controls-bottom stori-clearfix"></div>'),"top"!==a&&"both"!==a||b.prepend('<div class="stori-controls stori-controls-default stori-controls-top stori-clearfix"></div>'),d.opts.controlsHtml?b.find(".stori-controls").removeClass("stori-controls-default").append(d.opts.controlsHtml):(d.opts.buttonBack&&b.find(".stori-controls").append(d.opts.buttonBackHtml),d.opts.buttonForward&&b.find(".stori-controls").append(d.opts.buttonForwardHtml),d.opts.buttonRestart&&b.find(".stori-controls").append(d.opts.buttonRestartHtml),d.opts.linear&&d.opts.linearDropDown&&b.find(".stori-controls").append(d.selectHtml)))},d.pageGo=function(b,c,e){var f;if(void 0===c&&(c=d.opts.transition),void 0===e&&(e=!0),!(b=d.o2e(b))||!a(b).length)return null;f=d.current,e&&(d.pointer++,d.history=d.history.slice(0,d.pointer),d.historyAdd(b)),d.pageHideShow(f,b,c),d.current=d.history[d.pointer],d.controlsEnableDisable()},a(document).on("click","#"+d.id+" a[href^='#'], #"+d.id+" [data-page^='#']",function(b){var c=a(this).attr("href");return a(this).is(".stori-ignore, .stori-back, .stori-forward, .stori-restart")?null:(c||(c=a(this).attr("data-page")),c&&a(c).length?(b.preventDefault(),void d.pageGo(c)):(d.opts.debug&&console.warn("stori: Target element does not exist"),null))}),d.pageHideShow=function(a,b,c){var e=d.opts.transitionSpeed;a=d.e2o(a),b=d.e2o(b),void 0===c&&(c=d.opts.transition),"fade"===c?a.stop().fadeOut(e,function(){b.stop().fadeIn(e,function(){d.pageFocus(),d.initialLoad=!1})}):"slide"===c?a.stop().slideUp(e,function(){b.stop().slideDown(e,function(){d.pageFocus(),d.initialLoad=!1})}):(a.hide(),b.show(),d.pageFocus(),d.initialLoad=!1)},d.pageBack=function(){var a;if(!d.history||d.pointer<=0)return null;a=d.history[d.pointer],d.pointer--,d.current=d.history[d.pointer],d.pageHideShow(a,d.current),d.historySet(d.history),d.controlsEnableDisable()},a(document).on("click","#"+d.id+" .stori-back:not(.stori-ignore)",function(a){a.preventDefault(),d.pageBack()}),a(document).on("swipeleft","#"+d.id+" .stori-back:not(.stori-ignore)",function(a){a.preventDefault(),d.pageBack()}),d.pageForward=function(){var a;if(!d.history||d.pointer+1>=d.history.length)return null;a=d.history[d.pointer],d.pointer++,d.current=d.history[d.pointer],d.pageHideShow(a,d.current),d.historySet(d.history),d.controlsEnableDisable()},a(document).on("click","#"+d.id+" .stori-forward:not(.stori-ignore)",function(a){a.preventDefault(),d.pageForward()}),d.pageRestart=function(){var a=d.current;if(d.history.length<=1)return null;d.pointer=0,d.opts.linear||(d.history=[],d.historyAdd(d.opts.start)),d.current="#"+d.opts.start.attr("id"),d.pageHideShow(a,d.opts.start.attr("id")),d.controlsEnableDisable()},a(document).on("click","#"+d.id+" .stori-restart:not(.stori-ignore)",function(a){a.preventDefault(),d.pageRestart()}),d.pageFocus=function(){var b=a(d.current).find("input, a, select, textarea, button").first();d.opts.focus&&!d.initialLoad&&b.focus()},d.pageHistory=function(){return d.history},d.pagePosition=function(){return d.pointer},d.pageCurrent=function(){return d.history[d.pointer]},b.on("change","select.stori-pageList",function(b){var c=a(this).val(),e=d.linearName+c;d.pageGo(e,d.opts.transition,!1),d.pointer=c,d.current=d.history[c],d.controlsEnableDisable()}),d.historyAdd=function(a){a=d.o2e(a),d.history.push(a),d.current=d.history[d.pointer],d.historySet(d.history)},d.historyGet=function(){var a,b=[];return"session"===d.opts.history?(a=sessionStorage.getItem(d.historyName),d.pointer=sessionStorage.getItem(d.pointerName)):(a=localStorage.getItem(d.historyName),d.pointer=localStorage.getItem(d.pointerName)),d.pointer&&"null"!==d.pointer||(d.pointer=0),a&&(b=a.split(",")),b},d.historySet=function(a){"session"===d.opts.history?(sessionStorage.setItem(d.historyName,a+""),sessionStorage.setItem(d.pointerName,d.pointer)):(localStorage.setItem(d.historyName,a+""),localStorage.setItem(d.pointerName,d.pointer))},d.historyEmpty=function(){"session"===d.opts.history?sessionStorage.setItem(d.historyName,""):localStorage.setItem(d.historyName,"")},d.historyDestroy=function(){"session"===d.opts.history?(sessionStorage.removeItem(d.historyName),sessionStorage.removeItem(d.pointerName)):(localStorage.removeItem(d.historyName),localStorage.removeItem(d.pointerName))},d.controlsEnableDisable=function(){d.opts.buttonBack&&(d.pointer<=0?b.find(".stori-controls .stori-back").addClass("stori-disabled").prop("disabled",!0):b.find(".stori-controls .stori-back").removeClass("stori-disabled").prop("disabled",!1)),d.opts.buttonForward&&(d.pointer+1>=d.history.length?b.find(".stori-controls .stori-forward").addClass("stori-disabled").prop("disabled",!0):b.find(".stori-controls .stori-forward").removeClass("stori-disabled").prop("disabled",!1)),d.opts.buttonRestart&&(d.history.length<=1?b.find(".stori-controls .stori-restart").addClass("stori-disabled").prop("disabled",!0):b.find(".stori-controls .stori-restart").removeClass("stori-disabled").prop("disabled",!1)),d.opts.linear&&d.opts.linearDropDown&&b.find("select.stori-pageList").val(d.pointer)},d.e2o=function(b){return"string"==typeof b&&(b=b.trim(),b.startsWith("#")||(b="#"+b),b=a(b)),b&&b.length?b:(d.opts.debug&&console.warn("stori: Page doesn't exist or missing id"),null)},d.o2e=function(a){return a&&("string"==typeof a||(a=a.attr("id")))?(a.startsWith("#")||(a="#"+a),a):(d.opts.debug&&console.warn("stori: Page doesn't exist or missing id"),null)},window.onbeforeunload=function(){var a;if(d.opts.warn&&("clear"===d.opts.history?a="You will lose your progress if you leave this page. Continue?":"session"===d.opts.history&&(a="You will lose your progress if you close this window. Continue?"),!window.confirm(a)))return!1;"clear"===d.opts.history&&d.historyDestroy()},a(window).unload(function(){"clear"===d.opts.history&&d.historyDestroy()}),d.init(c)):(d.opts.debug&&console.warn("stori: Container element requires an id"),null)},a.fn.stori=function(c){return this.each(function(d,e){var f=a(e);if(!(f.data(b)instanceof a.Stori)){if("string"==typeof c&&f.data(b)){var g;if(g=f.data(b)[c[0]],a.isFunction(g))return g.apply(f,c[1])}return f.data(b,new a.Stori(f,c))}})}}(jQuery);